import datetime

import functools
from tarantool.response import Response
from asynctnt.ciproto.encdec import response_parse

data = b'\x83\x00\xce\x00\x00\x00\x00\x01\xcf\x00\x00\x00\x00\x00\x00\x00\x02\x05\xce\x00\x00\x004\x810\xdd\x00\x00' \
       b'\x00 \x96\xcd\x01\x10\x00\xa7primary\xa4tree\x81\xa6unique\xc3\x91\x92\x00\xa6string\x96\xcd\x01\x18\x00' \
       b'\xa7primary\xa4tree\x81\xa6unique\xc3\x91\x92\x00\xa8unsigned\x96\xcd\x01\x18\x01\xa5owner\xa4tree\x81' \
       b'\xa6unique\xc2\x91\x92\x01\xa8unsigned\x96\xcd\x01\x18\x02\xa4name\xa4tree\x81\xa6unique\xc3\x91\x92\x02' \
       b'\xa6string\x96\xcd\x01\x19\x00\xa7primary\xa4tree\x81\xa6unique\xc3\x91\x92\x00\xa8unsigned\x96\xcd\x01\x19' \
       b'\x01\xa5owner\xa4tree\x81\xa6unique\xc2\x91\x92\x01\xa8unsigned\x96\xcd\x01\x19\x02\xa4name\xa4tree\x81' \
       b'\xa6unique\xc3\x91\x92\x02\xa6string\x96\xcd\x01 ' \
       b'\x00\xa7primary\xa4tree\x81\xa6unique\xc3\x92\x92\x00\xa8unsigned\x92\x01\xa8unsigned\x96\xcd\x01 ' \
       b'\x02\xa4name\xa4tree\x81\xa6unique\xc3\x92\x92\x00\xa8unsigned\x92\x02\xa6string\x96\xcd\x01!\x00\xa7primary' \
       b'\xa4tree\x81\xa6unique\xc3\x92\x92\x00\xa8unsigned\x92\x01\xa8unsigned\x96\xcd\x01!\x02\xa4name\xa4tree\x81' \
       b'\xa6unique\xc3\x92\x92\x00\xa8unsigned\x92\x02\xa6string\x96\xcd\x01(' \
       b'\x00\xa7primary\xa4tree\x81\xa6unique\xc3\x91\x92\x00\xa8unsigned\x96\xcd\x01(' \
       b'\x01\xa5owner\xa4tree\x81\xa6unique\xc2\x91\x92\x01\xa8unsigned\x96\xcd\x01(' \
       b'\x02\xa4name\xa4tree\x81\xa6unique\xc3\x91\x92\x02\xa6string\x96\xcd\x01)\x00\xa7primary\xa4tree\x81' \
       b'\xa6unique\xc3\x91\x92\x00\xa8unsigned\x96\xcd\x01)\x01\xa5owner\xa4tree\x81\xa6unique\xc2\x91\x92\x01' \
       b'\xa8unsigned\x96\xcd\x01)\x02\xa4name\xa4tree\x81\xa6unique\xc3\x91\x92\x02\xa6string\x96\xcd\x010\x00' \
       b'\xa7primary\xa4tree\x81\xa6unique\xc3\x91\x92\x00\xa8unsigned\x96\xcd\x010\x01\xa5owner\xa4tree\x81' \
       b'\xa6unique\xc2\x91\x92\x01\xa8unsigned\x96\xcd\x010\x02\xa4name\xa4tree\x81\xa6unique\xc3\x91\x92\x02' \
       b'\xa6string\x96\xcd\x011\x00\xa7primary\xa4tree\x81\xa6unique\xc3\x91\x92\x00\xa8unsigned\x96\xcd\x011\x01' \
       b'\xa5owner\xa4tree\x81\xa6unique\xc2\x91\x92\x01\xa8unsigned\x96\xcd\x011\x02\xa4name\xa4tree\x81\xa6unique' \
       b'\xc3\x91\x92\x02\xa6string\x96\xcd\x018\x00\xa7primary\xa4tree\x81\xa6unique\xc3\x93\x92\x01\xa8unsigned\x92' \
       b'\x02\xa6string\x92\x03\xa8unsigned\x96\xcd\x018\x01\xa5owner\xa4tree\x81\xa6unique\xc2\x91\x92\x00' \
       b'\xa8unsigned\x96\xcd\x018\x02\xa6object\xa4tree\x81\xa6unique\xc2\x92\x92\x02\xa6string\x92\x03\xa8unsigned' \
       b'\x96\xcd\x019\x00\xa7primary\xa4tree\x81\xa6unique\xc3\x93\x92\x01\xa8unsigned\x92\x02\xa6string\x92\x03' \
       b'\xa8unsigned\x96\xcd\x019\x01\xa5owner\xa4tree\x81\xa6unique\xc2\x91\x92\x00\xa8unsigned\x96\xcd\x019\x02' \
       b'\xa6object\xa4tree\x81\xa6unique\xc2\x92\x92\x02\xa6string\x92\x03\xa8unsigned\x96\xcd\x01@\x00\xa7primary' \
       b'\xa4tree\x81\xa6unique\xc3\x91\x92\x00\xa8unsigned\x96\xcd\x01@\x01\xa4uuid\xa4tree\x81\xa6unique\xc3\x91' \
       b'\x92\x01\xa6string\x96\xcd\x02\x00\x00\xa7primary\xa4tree\x82\xa6unique\xc3\xa3lsn\t\x91\x92\x00\xa8unsigned '

N = 50000

class DummyConn:
    def __init__(self):
        self.encoding = 'utf-8'
        self.error = False

c = DummyConn()


def measure(n):
    def _measure(f):
        @functools.wraps(f)
        def wrap(*args, **kwargs):
            start = datetime.datetime.now()
            res = f(*args, **kwargs)
            end = datetime.datetime.now()
            elapsed = end - start
            print('Elapsed: {}, RPS: {}'.format(elapsed, n / elapsed.total_seconds()))
            return res
        return wrap
    return _measure


@measure(N)
def test1():
    for _ in range(N):
        Response(c, data)
    

@measure(N)
def test2():
    # r = response_parse(data)
    for _ in range(N):
        response_parse(data)


if __name__ == '__main__':
    test1()
    test2()
